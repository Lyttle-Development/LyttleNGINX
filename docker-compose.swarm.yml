version: '3.8'

services:
  lyttlenginx:
    image: ghcr.io/lyttle-development/lyttlenginx:main

    deploy:
      mode: global

      placement:
        max_replicas_per_node: 1

      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

      update_config:
        parallelism: 1
        delay: 5s
        failure_action: rollback
        monitor: 30s
        max_failure_ratio: 0.3
        order: stop-first

      rollback_config:
        parallelism: 1
        delay: 5s
        failure_action: pause
        monitor: 20s

      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s

      labels:
        - "app=lyttlenginx"
        - "version=1.0"

    environment:
      - DATABASE_URL=${DATABASE_URL}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - NODE_ENV=${NODE_ENV:-production}
      - RENEW_BEFORE_DAYS=${RENEW_BEFORE_DAYS:-30}
      - ALERT_THRESHOLD_DAYS=${ALERT_THRESHOLD_DAYS:-14}
      - LETSENCRYPT_STAGING=${LETSENCRYPT_STAGING:-false}
      - API_KEY=${API_KEY}
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - SMTP_FROM=${SMTP_FROM:-}
      - ALERT_EMAIL=${ALERT_EMAIL:-}
      - ALERT_FROM_EMAIL=${ALERT_FROM_EMAIL:-}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
      - RATE_LIMIT_TTL=${RATE_LIMIT_TTL:-60}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}

    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
      - target: 3000
        published: 3003
        protocol: tcp
        mode: host

    healthcheck:
      test: [ "CMD-SHELL", "/healthcheck.sh" ]
      interval: 10s
      timeout: 5s
      retries: 2
      start_period: 30s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "app,version"
